name: Nightly Deep Cycle
on:
  workflow_dispatch: {}
  schedule: [{ cron: "0 22 * * *" }]  # 23:00 svensk tid

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Kill-switch via Notion
        run: |
          curl -s -H "Authorization: Bearer $NOTION_API_KEY" \
               -H "Notion-Version: 2022-06-28" \
               https://api.notion.com/v1/databases/$NOTION_DB_FLAGS/query > flags.json
          if grep -qi '"STOP": *true' flags.json; then
            echo "STOP active, exiting"; exit 0; fi
    env:
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_DB_FLAGS: ${{ secrets.NOTION_DB_FLAGS }}

  run-cycle:
    needs: guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci || true

      - name: Configure Git identity
        run: |
          git config --local user.name  "${GITHUB_ACTOR}"
          git config --local user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Research (Perplexity)
        run: node scripts/research.js
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DB_RESEARCH: ${{ secrets.NOTION_DB_RESEARCH }}

      - name: Plan (Gemini → fallback Perplexity)
        run: node scripts/plan_tasks.js
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}

      - name: Make NotebookLM podcast briefs
        run: node scripts/make_podcast_briefs.js
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Pack briefs → TXT
        run: node scripts/pack_briefs.js

      - name: Upload briefs to Google Drive
        run: node scripts/upload_to_drive.js
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

      - name: Code apply (scaffolds + PRs)
        run: node scripts/code_apply.js
        continue-on-error: true

      - name: Create PR (fallback)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: nightly/auto-pr
          title: "Nightly: auto changes"
          commit-message: "chore(nightly): auto changes"

      - name: Morning brief → Notion
        if: always()
        run: node scripts/morning_brief.js
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DB_MORNING: ${{ secrets.NOTION_DB_MORNING }}

      - name: Show files created
        run: |
          echo "PWD = $(pwd)"
          ls -la
          echo "---- research ----";  [ -d research ] && find research -type f -maxdepth 2 -print || echo "no research dir"
          echo "---- plans ----";     [ -d plans ] && find plans -type f -maxdepth 2 -print || echo "no plans dir"
          echo "---- podcast ----";   [ -d podcast ] && find podcast -type f -maxdepth 3 -print || echo "no podcast dir"
          echo "---- reports ----";   [ -d reports ] && find reports -type f -maxdepth 2 -print || echo "no reports dir"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: night-artifacts
          path: |
            research/**
            plans/**
            podcast/briefs/**
            podcast/export/**
            reports/**
          if-no-files-found: error
          retention-days: 7
